# Bootstrapper, or spawning cytomine with docker-compose

A tool for deploying Cytomine with Docker Compose on one or more servers.

It should support:
- the most simple and self-contained initial configuration for a cytomine instance: `cytomine.yml`, one `docker compose.*.yml` file per target server and optional configuration files
- zero or minimal duplication of environment variables definition (e.g. urls, path, etc)
- a straightforward and simple way of converting the initial configuration files into deployment-ready files
- Cytomine services deployment on each target server with a simple `docker compose up` command (using the deployment files)

It should not support:
- automatic generation of Docker Compose files

Additional goals:
- deprecate `Cytomine-bootstrap` and `Cytomine-bootstrap-generator`

# Inputs

The inputs are the following:

- a `cytomine.yml` file: environment variables and configurations files
- one `docker-compose.*.yml` file per target server
- (optional) configuration files to mount on the containers at launch


## Compose files `docker-compose.*.yml`

Each docker-compose file defines what services should run on a specific server. The name of each compose file should specify a server identifier `docker-compose.IDENTIFIER.yml` (e.g. `docker-compose.core.yml`). In the case of mono-server install, the identifier can be omitted in which case the file must be named `docker-compose.yml`. 

All dockerfiles may use environment variables to be interpolated when `docker compose up` is called. These variables are defined in the `global` section of the `cytomine.yml` file (see next section).

## A configuration file: `cytomine.yml`

This files condenses the definition of environment variables and configuration files necessary to deploy the cytomine instance in a declarative way and contains two top-level sections: `envs` and `configs`.

### Section `envs`

The `envs` section itself contains two sub-sections:

- `global`: for defining global variables that can be referred to later in the `cytomine.yml` per-service section (see below) and in the `docker-compose.*.yml` file(s). These variables will only be used by the bootstrapper and will not be seen by the container unless specified.
- `per-service`: defines which environment variables will be attached to the containers

The hierarchy of environment variables in `envs` section is `envs.(global|per-service).{namespace}.{value-type}.{env-var-name}.{value}`:

- `namespace`: a namespace for environment variables (to keep them well organized and avoid unnecessary prefixing) 
- `value-type`: how the bootstrapper should interpret the specified `value` field to assign the value to the environment variable. Three possible types:
    - `constant`: read `value` as it is parsed by the YAML parser (`value` should be a primitive type) 
    - `auto`: the value is auto-generated by a method specified by `value` when the bootstrapper is executed:
        - `random-uuid`: generates a random uuid
        - `openssh`: random openssh string with given parameters (`base` and `length`)
    - `global` (not supported in `envs.global` section): value extracted from a variable defined in the `global` subsection (`value` should be `{namespace}.{env-var-name}`) 
- `env-var-name`: case-sensitive name of the environment variable
- `value`: the value to interpret based on `value-type`

The per-service namespace should match `{SERVICE}-{SERVER-IDENTIFIER}` where `SERVICE` is the name of the service in the docker compose file and `SERVER-IDENTIFIER` is the name of the identifier of the server as declared in the name of the docker compose file defining this service. In the case of mono-server install this latter term can be omitted and the namespace can just be: `{SERVICE}`. 

The `global` variables can be referred to in the docker compose files following the following naming convention: `${NAMESPACE}_{ENV-VAR-NAME}` or `${{{NAMESPACE}_{ENV-VAR-NAME}}}` (eg. `$IMGS_CORE` or `${IMGS_CORE}` if namespace is `imgs` and var name is `CORE`).  

### Section `configs`

Optionally, one can define a set of configuration files that will be attached to containers at launch. These files must be accessible relatively to the root folder of the configuration (same folder as `cytomine.yml`). 

These files should be listed on a per-service structure in the `cytomine.yml` file. The declaration should provide the target service for a mounted configuration fmount point on the target container

The hierarchy is the following: `configs.{namespace}.{config-group}` where namespace defines the service and server concerned with the configuration files. There can be several config groups for a service. Each group corresponds to one mount point on the container and can list several files (path relative to the cytomine root folder).

```yaml
configs:
  core-srv1:
    main:
      mount-point: /config
      files: ["./cytomine.config", "./othercytomine.config"]
  nginx-srv2:
    sites-enabled:
      mount-point: /etc/nginx/sites-enabled
      files: ["nginx/main.conf"]
```

# Bootstrapping and outputs

Before a docker-compose can be up'ed, the bootstrapper must read the `cytomine.yml` and generate deployment files.

This can be done by mounting the directory containing the inputs files (`cytomine.yml`, etc.) to a bootstrapper container as a `/bootstrap` folder and launching it:

```
docker run -v $(pwd):/bootstrap --user "$(id -u):$(id -g)" --rm --it BOOTSTRAPPER_IMAGE [... PARAMS]
```

This will generate a deployment folder in `/bootstrap/{FOLDER}` containing all files necessary for running the container. By default:

- `cytomine.yml`: a clone of the initial cytomine.yml file where auto-generated variables have been optionally moved to the constant sections (to keep the generated values). This file can be used for future configuration change
- a subfolder `{SERVER-IDENTIFIER}` for each target server containing:
  - `{SERVER-IDENTIFIER}/.env`: defines the environment variables to be interpolated in the docker-compose.yml file
  - `{SERVER-IDENTIFIER}/docker-compose.yml`: an unmodified clone of the initial `docker-compose.{SERVER-IDENTIFIER}.yml` file 
  - `{SERVER-IDENTIFIER}/docker-compose.override.yml`: an override Docker Compose file to attach environment variables (using files in `{SERVER-IDENTIFIER}/envs`) and mounting configuration files to each service
  - `{SERVER-IDENTIFIER}/envs/{SERVICE}.env`: .env files containing environment variables defined for the given service running on this server
  - `{SERVER-IDENTIFIER}/configs/{SERVICE}/{CONFIG-GROUP}/{CONFIG-FILE}`: configuration files organized by service and config groups.
