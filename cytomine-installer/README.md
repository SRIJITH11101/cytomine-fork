# Bootstrapper, or spawning cytomine with docker-compose

The goal is to launch Cytomine with a simple `docker-compose up` command and additionnally to:

- have the most self-contained configuration for a cytomine instance: `cytomine.yml` and `docker-compose.yml`
- avoid duplication of environment variables (e.g. urls, path, etc)
- be able to deploy a Cytomine instance on any system supporting Docker
- automatically generate the necessary files for spawning Cytomine from the `cytomine.yml`:
    - a ready-to-be-used `docker-compose.yml` file for spawning Cytomine 
    - `*.env` files defining what environment variables are passed to each container 
    - specific configurations files to be attached to each container in a mounted volume

## A configuration file: `cytomine.yaml`

This files condenses the configuration information of a cytomine instance in a declarative way  and contains 2 top-level subsections: `envs` and `configs`.

### Environment variables

The `envs` subsection itself contains two sub-sections:

- `global`: for defining global variables that can be referred to in later `cytomine.yml` sections, in the `docker-compose.yml` file or in the configurations sample files. These variables will only be used by the bootstrapper.
- `per-service`: defines which environment variables will be passed to the containers spawned from to docker-compose file. 

The hierarchy in the `cytomine.yml` file is `envs.(global|per-service).{namespace}.{value-type}.{env-var-name}.{value}`:

- `namespace`: a namespace for environment variables (to keep them well organized and avoid unnecessary prefixing). 
- `value-type`: how the bootstrapper should interpret the specified `value` field to assign the value to the environment variable. Three possible types:
    - `set`: read `value` as it is parsed by the YAML parser (`value` should be a primitive type) 
    - `autogenerate`: the value is generated by a method specified by `value`:
        - `random-uuid`: generates a random uuid
        - `openssh`: random openssh string with given parameters (`base` and `length`)
    - `global` (not supported in `global` subsection): value extracted from a variable defined in the `global` subsection (`value` should be `{namespace}.{env-var-name}`) 
- `env-var-name`: case-sensitive name of the environment variable
- `value`: the value to interpret based on `value-type`

### Configuration files

The last subsection is where configuration sample files should be defined where `config.{service}` is an array listing relative file paths (from working directory) to this service config files.

## Docker-compose file

The file `docker-compose.yaml` is a classical docker-compose file. Variables defined in the `global` subsection of `cytomine.yaml` can be used in the file using the docker-compose interpolation system. A variable should be referred to as `${NAMESPACE}_{ENV-VAR-NAME}` or `${{{NAMESPACE}_{ENV-VAR-NAME}}}` (eg. `$IMGS_CORE` or `${IMGS_CORE}` if namespace is `imgs` and var name is `CORE`).  

## Boostrapping

Before the docker-composed can be up'ed, the bootstrapper must convert the `cytomine.yml` into a bunch of environment and configuration files.

This can be done by mounting the directory containing the `cytomine.yml` and `docker-compose.yml` to a bootstrapper container and launching it:

```
docker run -v $(pwd):/code --user "$(id -u):$(id -g)" --rm --it BOOTSTRAPPER_IMAGE
```

This will generate a deployment folder containing all files necessary for running the container. By default:

- `./{PATH}/configs/{service}/`: each service that has configuration file samples will have a directory with its generated configuration files. The generation consists in interpolating the placeholders in the config files with the values defined in the `cytomine.yml` file.  
- `./{PATH}/envs/{service}.env`: each service that has environment variables will have a `.env` file created containing all the environment variables that should be passed to the container
- `./{PATH}/.env`: environment variables for docker-compose file interpolation
- `./{PATH}/docker-compose.override.yml`: a second docker-compose file that increases the first with definition of mount points for configuration files and specification of environment files
- `./{PATH}/docker-compose.yml`: a copy of the initial `docker-compose.yml` file 

